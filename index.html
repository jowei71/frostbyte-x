<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>FrostByte X</title>
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="data:application/manifest+json,{\"name\":\"FrostByte X\",\"short_name\":\"FrostByte\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#000\",\"theme_color\":\"#000\"}">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <style>
    body,html{margin:0;padding:0;height:100vh;background:#000;color:#0f0;font-family:system-ui;overflow:hidden;}
    .beam{position:fixed;top:0;left:0;right:0;height:6px;background:#0f0;box-shadow:0 0 50px #0f0;animation:b 2.5s infinite linear;z-index:50;}
    @keyframes b{0%{top:-10%}100%{top:110%}}
    .mode-btn{padding:10px 20px;border:2px solid #0f0;border-radius:50px;background:#000;font-weight:900;font-size:14px;transition:all .3s;}
    .mode-btn.active{background:#0f0;color:#000;}
    #video{width:100vw;height:100vh;object-fit:cover;}
    #overlay{position:fixed;inset:0;pointer-events:none;border:4px solid transparent;transition:all .3s;}
    .detected{border-color:#0f0 !important;box-shadow:0 0 40px #0f0;}
    #result{position:fixed;inset:0;background:rgba(0,0,0,0.95);padding:20px;overflow-y:auto;z-index:100;}
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="fixed top-0 left-0 right-0 z-40 p-4 flex justify-between items-center bg-black/80 backdrop-blur">
    <h1 class="text-2xl font-black">FrostByte <span class="text-green-400">X</span></h1>
    <button id="close-result" class="text-3xl">Ã—</button>
  </div>

  <!-- Mode selector -->
  <div class="fixed bottom-24 left-0 right-0 z-40 flex justify-center gap-3 flex-wrap px-4">
    <button class="mode-btn active" data-mode="Expiry">Food</button>
    <button class="mode-btn" data-mode="Medicine">Medicine</button>
    <button class="mode-btn" data-mode="Crypto Seed">Crypto</button>
    <button class="mode-btn" data-mode="Love Letter">Love</button>
    <button class="mode-btn" data-mode="Mystery">Any</button>
  </div>

  <!-- Camera -->
  <video id="video" autoplay playsinline></video>
  <div class="beam"></div>
  <div id="overlay"></div>

  <!-- Result screen (hidden by default) -->
  <div id="result" class="hidden flex flex-col">
    <div class="flex-1 flex flex-col items-center justify-center text-center px-6">
      <h2 id="title" class="text-5xl font-black text-green-400 mb-6"></h2>
      <img id="photo" class="max-w-full rounded-2xl border-4 border-green-400 mb-6">
      <div id="data" class="text-xl font-mono text-green-300 break-all bg-black/50 p-6 rounded-2xl"></div>
      <button id="share" class="mt-8 px-12 py-5 bg-green-500 text-black rounded-xl font-black text-xl">SHARE</button>
    </div>
  </div>

  <script>
    let stream, currentMode = "Expiry";
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');

    // Start camera instantly
    navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s=>{
      stream = s;
      video.srcObject = stream;
    });

    // Mode switch
    document.querySelectorAll('[data-mode]').forEach(b=>{
      b.onclick = () => {
        document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        currentMode = b.dataset.mode;
      };
    });

    // Auto-capture when text is detected
    let lastScan = 0;
    async function scanLoop() {
      if (!video.videoWidth) return requestAnimationFrame(scanLoop);
      
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);

      // Only scan every 800ms to save battery
      if (Date.now() - lastScan > 800) {
        lastScan = Date.now();
        try {
          const result = await Tesseract.recognize(canvas, 'eng', {logger: m => {}});
          const text = result.data.text.toUpperCase();
          
          if (text.length > 20) { // something readable
            overlay.classList.add('detected');
            setTimeout(() => autoCapture(canvas, text), 600); // slight delay for stability
          } else {
            overlay.classList.remove('detected');
          }
        } catch(e) {}
      }
      requestAnimationFrame(scanLoop);
    }
    scanLoop();

    function autoCapture(canvas, text) {
      if (document.getElementById('result').classList.contains('hidden')) {
        const img = canvas.toDataURL('image/jpeg', 0.9);
        const extracted = extract(text);
        showResult(extracted, img);
        stream.getTracks().forEach(t=>t.stop());
      }
    }

    function extract(text) {
      const patterns = {
        Expiry: /(EXP|BEST BEFORE|USE BY|BBE).{0,50}?\d{1,2}[-\/\.]\d{1,2}[-\/\.]\d{2,4}/,
        Medicine: /(EXP|USE BY).{0,50}?\d{4}-\d{2}-\d{2}/,
        "Crypto Seed": /\b([A-Z]{3,10}\s+){11,23}[A-Z]{3,10}\b/,
        "Love Letter": /(LOVE|DARLING|BABY|FOREVER).{0,100}?\d{4}/,
      };
      const match = text.match(patterns[currentMode] || /.+/);
      if (currentMode === "Crypto Seed" && match) return {type:"CRYPTO SEED DETECTED", data:match[0], warning:"NEVER SHARE!"};
      if (currentMode === "Love Letter" && match) return {type:"LOVE LETTER", data:"Someone loves you", romantic:true};
      return {type: match ? currentMode.toUpperCase() : "FOUND", data: match ? match[0] : text.slice(0,300)};
    }

    function showResult(info, img) {
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('title').textContent = info.type;
      document.getElementById('photo').src = img;
      document.getElementById('data').innerHTML = `
        <div class="text-3xl mb-4">${info.data}</div>
        ${info.warning ? `<div class="text-red-500 animate-pulse text-2xl">Warning: ${info.warning}</div>` : ''}
        ${info.romantic ? `<div class="text-pink-400 text-8xl mt-8">Love Love Love</div>` : ''}
      `;
      confetti({particleCount:400, spread:200, origin:{y:0.6}});
    }

    document.getElementById('close-result').onclick = () => {
      document.getElementById('result').classList.add('hidden');
      navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s=>{
        stream = s;
        video.srcObject = stream;
      });
    };

    document.getElementById('share').onclick = () => navigator.share?.({title:"FrostByte X", url:location.href});
  </script>
</body>
</html>