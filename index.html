<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>FrostByte X • AI Scanner</title>
  <meta name="theme-color" content="#00ff9d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0/dist/index.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;600;800&display=swap');
    
    * { margin:0; padding:0; box-sizing:border-box; }
    body,html { height:100dvh; background:linear-gradient(135deg,#0a001f,#001a33); color:#fff; font-family:'Inter',sans-serif; overflow:hidden; }
    
    .glass { background:rgba(255,255,255,0.08); backdrop-filter:blur(20px); border:1px solid rgba(0,255,157,0.3); box-shadow:0 8px 32px rgba(0,255,157,0.1); }
    
    .scanline { position:fixed; top:0; left:0; width:100%; height:6px; background:#00ff9d; box-shadow:0 0 60px #00ff9d; animation:scan 3s infinite linear; z-index:10; }
    @keyframes scan { 0%{top:-10%} 100%{top:110%} }
    
    .btn-capture { width:90px; height:90px; background:#fff; border-radius:50%; box-shadow:0 15px 50px rgba(0,255,157,0.6); }
    .btn-capture:active { transform:scale(0.88); }
    
    .flash { animation:flash 0.25s; }
    @keyframes flash { 50% { background:#fff; } }
    
    .title { font-family:'Orbitron',sans-serif; font-size:3.5rem; background:linear-gradient(90deg,#00ff9d,#00d4ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    
    .card { background:rgba(0,255,157,0.1); border:2px solid #00ff9d; }
    
    .hidden { display:none!important; }
    .center { display:grid; place-items:center; height:100dvh; }
  </style>
</head>
<body class="text-white">

  <!-- START -->
  <div id="start" class="center px-8 text-center">
    <h1 class="title mb-4">FROSTBYTE X</h1>
    <p class="text-2xl mb-12 opacity-90">AI Scanner • Food • Medicine • QR • Barcode • ID</p>
    <button id="begin" class="px-16 py-8 bg-gradient-to-r from-cyan-500 to-emerald-500 text-black text-3xl font-black rounded-3xl shadow-2xl hover:shadow-emerald-500/50 transition">
      START SCANNING
    </button>
  </div>

  <!-- CAMERA -->
  <div id="cam" class="hidden relative">
    <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
    <div class="scanline"></div>
    <div class="absolute inset-0 flex flex-col justify-between p-8 pointer-events-none">
      <div class="text-center">
        <p class="text-xl font-bold bg-black/60 px-6 py-3 rounded-full inline-block">Live AI Scanning...</p>
      </div>
      <button id="snap" class="btn-capture pointer-events-auto mx-auto"></button>
    </div>
    <button onclick="location.reload()" class="absolute top-8 right-8 w-14 h-14 bg-black/70 rounded-full text-3xl z-50">X</button>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden center px-8">
    <div class="card rounded-3xl p-10 max-w-lg w-full text-center">
      <div class="text-9xl mb-8" id="emoji">Package</div>
      <h2 class="text-4xl font-black mb-6" id="name">Unknown Item</h2>
      <p class="text-6xl font-black mb-4" id="days" style="color:#00ff9d"></p>
      <p class="text-2xl mb-8 opacity-90" id="warning"></p>
      <img id="photo" class="w-full rounded-2xl border-4 border-emerald-500 mb-8 shadow-2xl">
      <div class="space-y-4">
        <button onclick="speak()" class="w-full py-5 bg-cyan-600 hover:bg-cyan-500 rounded-2xl font-bold text-xl">
          SPEAK RESULT
        </button>
        <button onclick="location.reload()" class="w-full py-6 bg-gradient-to-r from-emerald-500 to-cyan-500 text-black font-black text-2xl rounded-2xl">
          SCAN AGAIN
        </button>
      </div>
    </div>
  </div>

  <audio id="beep" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
  <audio id="shutter" src="https://assets.mixkit.co/sfx/preview/mixkit-camera-shutter-click-564.mp3" preload="auto"></audio>

  <script>
    let stream, worker, reader, lastPhoto = "";

    // American, fast, confident voice
    function speak() {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(
          document.getElementById('name').textContent + ". " +
          document.getElementById('days').textContent + ". " +
          document.getElementById('warning').textContent
        );
        msg.rate = 1.1;
        msg.pitch = 1;
        msg.lang = 'en-US';
        const voices = speechSynthesis.getVoices();
        const american = voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) || voices[0];
        if (american) msg.voice = american;
        speechSynthesis.speak(msg);
      }
    }

    document.getElementById('begin').onclick = async () => {
      document.getElementById('start').classList.add('hidden');
      document.getElementById('cam').classList.remove('hidden');

      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      const video = document.getElementById('video');
      video.srcObject = stream;

      reader = new ZXing.BrowserMultiFormatReader();
      reader.decodeFromVideoDevice(null, video, (result) => {
        if (result) {
          document.getElementById('beep').play();
          handleCode(result.getText());
        }
      });
    };

    document.getElementById('snap').onclick = async () => {
      document.getElementById('shutter').play();
      document.body.classList.add('flash');
      setTimeout(() => document.body.classList.remove('flash'), 250);
      if ('vibrate' in navigator) navigator.vibrate(100);

      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      lastPhoto = canvas.toDataURL('image/jpeg', 0.9);

      stream.getTracks().forEach(t => t.stop());
      reader?.reset();
      document.getElementById('cam').classList.add('hidden');

      worker = worker || await Tesseract.createWorker('eng');
      const { data: { text } } = await worker.recognize(canvas);
      analyzeItem(text, lastPhoto);
    };

    function handleCode(code) {
      stream.getTracks().forEach(t => t.stop());
      reader.reset();
      document.getElementById('cam').classList.add('hidden');

      if (code.includes('http') || code.length > 50) {
        showResult("QR Code", code.substring(0,80)+(code.length>80?'...':''), "Tap to open link", "QR Code", "");
        setTimeout(() => window.open(code, '_blank'), 2000);
      } else {
        fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`)
          .then(r => r.json())
          .then(d => {
            const name = d.product?.product_name || "Unknown Product";
            showResult(name, "Barcode Scanned", `Code: ${code}`, "Barcode", lastPhoto || "");
          })
          .catch(() => showResult("Product", code, "Offline barcode", "Barcode", lastPhoto || ""));
      }
    }

    function analyzeItem(text, photo) {
      const t = text.toUpperCase().replace(/O/g,'0').replace(/I/g,'1');

      // Find expiry
      const dates = (t.match(/\d{1,2}[\/\-\.\s]\d{1,2}[\/\-\.\s]\d{2,4}|\d{4}[\/\-\.\s]\d{2}[\/\-\.\s]\d{2}|(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)[\s\-\.\/]*\d{1,2}|\d{6,8}|EXP[^\d]{0,20}\d+|BEST BEFORE[^\d]{0,20}\d+/gi) || [])
        .map(d => new Date(d.replace(/EXP|BEST BEFORE|USE BY|BB.?/gi,'').trim()))
        .filter(d => !isNaN(d) && d > new Date('2015'));

      const expiry = dates.sort((a,b)=>a-b)[0];
      const days = expiry ? Math.max(0, Math.ceil((expiry - Date.now()) / 86400000)) : null;

      // Detect type
      let name = "Item", emoji = "Package", warning = "";
      if (t.includes("PASSPORT") || t.includes("IDENTITY")) { name="Passport/ID Card"; emoji="Passport"; warning="Personal document detected"; }
      else if (t.includes("MEDICINE") || t.includes("TABLET") || t.includes("SYRUP")) { name="Medicine"; emoji="Pill"; warning="Check dosage carefully"; }
      else if (t.includes("MILK")) { name="Milk"; emoji="Milk"; }
      else if (t.includes("YOGURT")) { name="Yogurt"; emoji="Yogurt"; }
      else if (t.includes("EGG")) { name="Eggs"; emoji="Egg"; }
      else if (t.includes("CHICKEN")) { name="Chicken"; emoji="Chicken"; }

      // Final message
      let daysText = "", warningText = "";
      if (days === null) {
        daysText = "No expiry found";
        warningText = "Check manually or scan barcode";
      } else if (days === 0) {
        daysText = "EXPIRED TODAY";
        warningText = "Throw away immediately";
      } else if (days <= 2) {
        daysText = `${days} DAY${days>1?'S':''} LEFT`;
        warningText = "USE RIGHT NOW!";
      } else {
        daysText = `${days} days left`;
        warningText = "Still safe to consume";
      }

      showResult(name, daysText, warningText, emoji, photo);
      speak();
    }

    function showResult(name, days, warning, emoji, photo) {
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('name').textContent = name;
      document.getElementById('days').textContent = days;
      document.getElementById('days').style.color = days.includes("EXPIRED") || days.includes("NOW") ? "#ff0066" : "#00ff9d";
      document.getElementById('warning').textContent = warning;
      document.getElementById('emoji').textContent = emoji;
      if (photo) document.getElementById('photo').src = photo;
      confetti({ particleCount: 600, spread: 120, origin: { y: 0.6 } });
    }

    // Load voices when ready
    speechSynthesis.onvoiceschanged = () => {};
  </script>
</body>
</html>