<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>FrostByte X • Expiry Master</title>
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\":\"FrostByte X\",
    \"short_name\":\"FrostByte\",
    \"start_url\":\".\",
    \"display\":\"standalone\",
    \"background_color\":\"#000\",
    \"theme_color\":\"#000\",
    \"icons\":[{\"src\":\"https://frostbytex.app/icon-512.png\",\"sizes\":\"512x512\",\"type\":\"image/png\"}]
  }">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <style>
    body,html{margin:0;padding:0;height:100dvh;background:#000;color:#0f0;font-family:system-ui;overflow:hidden;}
    #video{width:100vw;height:100dvh;object-fit:cover;background:#111;}
    .beam{position:fixed;top:0;left:0;right:0;height:8px;background:#0f0;box-shadow:0 0 80px #0f0;animation:scan 3s infinite linear;z-index:20;}
    @keyframes scan{0%{top:-10%}100%{top:110%}}
    .safe{color:#0f0;text-shadow:0 0 20px #0f0;}
    .warning{color:#ff9500;text-shadow:0 0 20px #ff9500;}
    .danger{color:#ff3b30;text-shadow:0 0 20px #ff3b30;animation:pulse 1s infinite;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
    .big{font-size:4.5rem;font-weight:900;line-height:1;}
    .btn{padding:16px 32px;border:4px solid #0f0;background:#000;font-weight:900;border-radius:50px;transition:all .3s;}
    .btn:active{transform:scale(0.95);background:#0f0;color:#000;}
  </style>
</head>
<body>

  <!-- Splash / Start -->
  <div id="splash" class="fixed inset-0 flex flex-col items-center justify-center text-center p-8 bg-black">
    <h1 class="big mb-4 glitch">FROSTBYTE <span class="text-green-400">X</span></h1>
    <p class="text-2xl mb-12">Never eat expired food again</p>
    <button id="start" class="btn text-3xl">START SCANNER</button>
  </div>

  <!-- Camera View -->
  <video id="video" autoplay muted playsinline class="hidden"></video>
  <div class="beam hidden"></div>

  <!-- Live Status -->
  <div id="status" class="hidden fixed bottom-32 left-0 right-0 text-center text-2xl font-black z-10">
    Scanning for dates...
  </div>

  <!-- Result Screen -->
  <div id="result" class="hidden fixed inset-0 bg-black flex flex-col items-center justify-center p-8 text-center">
    <h2 id="title" class="big mb-8"></h2>
    <div id="days" class="text-6xl font-black mb-8"></div>
    <div id="advice" class="text-4xl font-black mb-12 max-w-lg"></div>
    <img id="photo" class="max-w-full rounded-3xl border-8 border-green-400 mb-12 shadow-2xl">
    <button onclick="location.reload()" class="btn text-3xl">SCAN NEXT ITEM</button>
  </div>

  <script>
    const video = document.getElementById('video');

    document.getElementById('start').onclick = async () => {
      document.getElementById('splash').classList.add('hidden');
      video.classList.remove('hidden');
      document.querySelector('.beam').classList.remove('hidden');
      document.getElementById('status').classList.remove('hidden');

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment", width: {ideal:1920}, height: {ideal:1080} }
      });
      video.srcObject = stream;
      video.play();

      setTimeout(scanLoop, 1500);
    };

    async function scanLoop() {
      if (!video.videoWidth) return setTimeout(scanLoop, 500);

      const canvas = document.createElement('canvas');
      canvas.width = 1000;
      canvas.height = video.videoHeight * (1000 / video.videoWidth);
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

      try {
        const worker = await Tesseract.createWorker('eng', 1, { logger: () => {} });
        const { data: { text } } = await worker.recognize(canvas);
        await worker.terminate();

        const dates = findAllDates(text);
        if (dates.length === 0) throw "no date";

        const best = getBestExpiry(dates);
        const img = canvas.toDataURL('image/jpeg', 0.9);

        showResult(best, img);
        video.srcObject.getTracks().forEach(t => t.stop());
      } catch (e) {
        setTimeout(scanLoop, 800);
      }
    }

    function findAllDates(text) {
      const t = text.toUpperCase().replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5');
      const regexes = [
        /\b(\d{1,2})[-\/\.]\s*(\d{1,2})[-\/\.]\s*(\d{2,4})\b/g,
        /\b(\d{4})[-\/\.]\s*(\d{2})[-\/\.]\s*(\d{2})\b/g,
        /\b(\d{1,2})\s*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)[A-Z]*\s*(\d{2,4})\b/gi,
        /\b(EXP|USE BY|BEST BEFORE|BB|BBE)[\s:]*\s*([A-Z0-9\/\-\.]{6,12})\b/gi,
        /\b\d{6,8}\b/g
      ];

      const found = new Set();
      regexes.forEach(r => {
        let m;
        while ((m = r.exec(t)) !== null) {
          const raw = m[0].replace(/[^0-9A-Z]/g,'');
          const d = parseAnyDate(raw);
          if (d && d > new Date('2010')) found.add(d);
        }
      });
      return Array.from(found).sort((a,b)=>a-b);
    }

    function parseAnyDate(str) {
      if (str.length === 6 || str.length === 8) {
        const d = str.slice(0,2), m = str.slice(2,4), y = (str.length===6?"20":"") + str.slice(-2);
        return new Date(y, m-1, d);
      }
      try { return new Date(str); } catch(e) { return null; }
    }

    function getBestExpiry(dates) {
      const now = Date.now();
      let closestFuture = null;
      let closestPast = null;

      dates.forEach(d => {
        const diff = d - now;
        if (diff > 0 && (!closestFuture || diff < closestFuture.diff)) {
          closestFuture = {date:d, diff};
        }
        if (diff < 0 && (!closestPast || diff > closestPast.diff)) {
          closestPast = {date:d, diff};
        }
      });

      return closestFuture || closestPast || {date:new Date(), diff:0};
    }

    function showResult(expiry, img) {
      const days = Math.round(expiry.diff / 86400000);
      const absDays = Math.abs(days);

      let title = "", daysText = "", advice = "", cls = "";

      if (days > 30) {
        title = "SAFE";
        daysText = `${absDays}+ days left`;
        advice = "You're good — enjoy!";
        cls = "safe";
      } else if (days > 7) {
        title = "SAFE";
        daysText = `${days} days left`;
        advice = "Still fresh — no rush";
        cls = "safe";
      } else if (days > 0) {
        title = "USE SOON";
        daysText = `Only ${days} day${days>1?'s':''} left`;
        advice = "Eat today or tomorrow!";
        cls = "warning";
      } else if (days > -7) {
        title = "EXPIRED";
        ";
        daysText = `Expired ${absDays} day${absDays>1?'s':''} ago`;
        advice = "Smell test it... maybe okay";
        cls = "warning";
      } else {
        title = "THROW NOW        ";
        daysText = `Expired ${absDays} days ago`;
        advice = "Bin it. Not worth the risk.";
        cls = "danger";
      }

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('title').textContent = title;
      document.getElementById('title').className = cls;
      document.getElementById('days').textContent = daysText;
      document.getElementById('days').className = cls;
      document.getElementById('advice').textContent = advice;
      document.getElementById('advice').className = cls;
      document.getElementById('photo').src = img;

      confetti({particleCount:500, spread:180, origin:{y:0.5}});
    }
  </script>
</body>
</html>