<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>FrostByte X • AI Scanner</title>
  <meta name="theme-color" content="#00ff9d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\":\"FrostByte X\",
    \"short_name\":\"FrostByte\",
    \"start_url\":\".\",
    \"display\":\"standalone\",
    \"background_color\":\"#000814\",
    \"theme_color\":\"#00ff9d\",
    \"icons\":[{\"src\":\"https://frostbyte.x/icon.png\",\"sizes\":\"512x512\",\"type\":\"image/png\"}]
  }">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0/dist/index.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700;900&display=swap" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body,html { height:100dvh; background:#000814; color:#fff; font-family:'Space Grotesk',sans-serif; overflow:hidden; }
    
    .glass { background: rgba(255,255,255,0.07); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(0,255,157,0.25); }
    
    .scan-beam {
      position: fixed; top: -10%; left: 0; width: 100%; height: 4px;
      background: linear-gradient(90deg, transparent, #00ff9d, transparent);
      box-shadow: 0 0 40px #00ff9d, 0 0 80px #00ff9d;
      animation: beam 3s infinite linear;
      z-index: 20;
    }
    @keyframes beam { 0% { top: -10%; } 100% { top: 110%; } }
    
    .capture-ring {
      width: 92px; height: 92px; border: 6px solid rgba(255,255,255,0.3);
      border-top-color: #00ff9d; border-radius: 50%; animation: spin 1.5s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .flash { animation: flash 0.3s; }
    @keyframes flash { 50% { background: #fff; } }
    
    .glow-text { text-shadow: 0 0 30px #00ff9d; }
    .card-glow { box-shadow: 0 20px 60px rgba(0,255,157,0.3); }
    
    .hidden { display:none!important; }
    .center { display:grid; place-items:center; height:100dvh; }
  </style>
</head>
<body>

  <!-- SPLASH / START -->
  <div id="splash" class="center px-6 text-center">
    <div class="text-center">
      <h1 class="text-6xl md:text-7xl font-black mb-4 bg-gradient-to-r from-cyan-400 to-emerald-400 bg-clip-text text-transparent">
        FROSTBYTE X
      </h1>
      <p class="text-xl md:text-2xl mb-12 opacity-90">AI Scanner • Food • Medicine • QR • Barcode • Passport</p>
      <button id="startBtn" class="px-20 py-7 bg-gradient-to-r from-emerald-500 to-cyan-500 text-black text-3xl font-black rounded-3xl shadow-2xl hover:shadow-emerald-500/60 transition-all transform hover:scale-105">
        START SCANNING
      </button>
    </div>
  </div>

  <!-- CAMERA VIEW -->
  <div id="camera" class="hidden relative h-screen">
    <video id="video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover"></video>
    <div class="scan-beam"></div>
    
    <div class="absolute top-8 left-0 right-0 text-center z-30">
      <div class="inline-block bg-black/60 backdrop-blur-md px-8 py-4 rounded-full border border-emerald-500/50">
        <p class="text-lg font-bold text-emerald-400">Live AI Scanning</p>
      </div>
    </div>

    <div class="absolute bottom-12 left-1/2 transform -translate-x-1/2 z-30">
      <button id="captureBtn" class="relative">
        <div class="capture-ring absolute inset-0"></div>
        <div class="w-24 h-24 bg-white rounded-full shadow-2xl"></div>
      </button>
    </div>

    <button onclick="location.reload()" class="absolute top-8 right-8 w-14 h-14 bg-black/70 rounded-full text-3xl z-40 flex items-center justify-center">
      ×
    </button>
  </div>

  <!-- RESULT SCREEN -->
  <div id="result" class="hidden center px-6">
    <div class="glass card-glow rounded-3xl p-10 max-w-xl w-full text-center space-y-8">
      <div class="text-9xl" id="emoji">Package</div>
      <h2 class="text-5xl font-black glow-text" id="productName">Loading...</h2>
      <p class="text-6xl font-black" id="expiryText" style="color:#00ff9d"></p>
      <p class="text-2xl opacity-90" id="statusText"></p>
      
      <img id="capturedPhoto" class="w-full max-w-md mx-auto rounded-2xl border-4 border-emerald-500 shadow-2xl mt-6">

      <div class="grid grid-cols-2 gap-4 mt-10">
        <button onclick="speakResult()" class="py-5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl font-bold text-xl hover:scale-105 transition">
          SPEAK RESULT
        </button>
        <button onclick="location.reload()" class="py-5 bg-gradient-to-r from-emerald-500 to-cyan-500 text-black rounded-2xl font-black text-xl hover:scale-105 transition">
          SCAN AGAIN
        </button>
      </div>
    </div>
  </div>

  <!-- AUDIO -->
  <audio id="shutter" src="https://assets.mixkit.co/sfx/preview/mixkit-camera-shutter-click-564.mp3" preload="auto"></audio>
  <audio id="success" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>

  <script>
    let stream, worker, barcodeReader, photoData = "";

    // Best American voice (fast & clear)
    function speakResult() {
      if (!('speechSynthesis' in window)) return;
      speechSynthesis.cancel();
      const text = `${document.getElementById('productName').textContent}. ${document.getElementById('expiryText').textContent}. ${document.getElementById('statusText').textContent}`;
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 1.15;
      utter.pitch = 1.05;
      utter.volume = 1;
      utter.lang = 'en-US';

      const voices = speechSynthesis.getVoices();
      const bestVoice = voices.find(v => v.lang.startsWith('en-US') && (v.name.includes('Google') || v.name.includes('Karen') || v.name.includes('Samantha'))) 
                       || voices.find(v => v.lang.startsWith('en')) 
                       || voices[0];
      if (bestVoice) utter.voice = bestVoice;

      speechSynthesis.speak(utter);
    }

    document.getElementById('startBtn').onclick = async () => {
      document.getElementById('splash').classList.add('hidden');
      document.getElementById('camera').classList.remove('hidden');

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: {ideal: 1920}, height: {ideal: 1080} }
        });
        document.getElementById('video').srcObject = stream;

        // Real-time barcode/QR scanner
        barcodeReader = new ZXing.BrowserMultiFormatReader();
        barcodeReader.decodeFromVideoDevice(undefined, 'video', (result) => {
          if (result) {
            document.getElementById('success').play();
            handleBarcode(result.getText());
          }
        });

      } catch (e) {
        alert("Camera access denied. Please allow camera in settings.");
      }
    };

    document.getElementById('captureBtn').onclick = async () => {
      document.getElementById('shutter').play();
      document.body.classList.add('flash');
      setTimeout(() => document.body.classList.remove('flash'), 300);
      if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);

      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      photoData = canvas.toDataURL('image/jpeg', 0.95);

      stream.getTracks().forEach(t => t.stop());
      barcodeReader?.reset();
      document.getElementById('camera').classList.add('hidden');

      // OCR with better accuracy
      worker = worker || await Tesseract.createWorker('eng', 1, {
        workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/worker.min.js',
        corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@5.1.0/tesseract-core.wasm.js',
      });

      const { data: { text } } = await worker.recognize(canvas);
      analyzeWithAI(text);
    };

    function handleBarcode(code) {
      stream.getTracks().forEach(t => t.stop());
      barcodeReader.reset();

      if (code.startsWith('http') || code.length > 60) {
        showResult("QR Code Detected", code.substring(0, 100), "Opening link...", "QR Code", photoData || "");
        setTimeout(() => window.open(code, '_blank'), 1500);
      } else {
        // Try OpenFoodFacts
        fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`)
          .then(r => r.json())
          .then(data => {
            const name = data.product?.product_name_en || data.product?.product_name || "Product";
            showResult(name, "Barcode Scanned", `Code: ${code}`, "Barcode", photoData || "");
          })
          .catch(() => showResult("Product Found", code, "Offline mode", "Barcode", photoData || ""));
      }
    }

    function analyzeWithAI(text) {
      const cleaned = text.toUpperCase()
        .replace(/[^A-Z0-0-9\/\.\-\s]/g, ' ')
        .replace(/O/g, '0').replace(/I/g, '1').replace(/S/g, '5');

      // SUPER ACCURATE DATE DETECTION
      const datePatterns = [
        /\b(\d{1,2})[\/\-\.\s](\d{1,2})[\/\-\.\s](\d{2,4})\b/,
        /\b(\d{4})[\/\-\.\s](\d{1,2})[\/\-\.\s](\d{1,2})\b/,
        /\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)[A-Z\s\-\.\/]*(\d{1,2})[\s\,]*(\d{2,4})?\b/,
        /\bEXP.?[:\s]*\d{1,2}.\d{1,2}/,
        /\b\d{6,8}\b/
      ];

      let bestDate = null;
      for (let pattern of datePatterns) {
        const match = cleaned.match(pattern);
        if (match) {
          const candidate = new Date(match[0]);
          if (!isNaN(candidate) && candidate > new Date('2018')) {
            if (!bestDate || candidate > bestDate) bestDate = candidate;
          }
        }
      }

      const daysLeft = bestDate ? Math.max(0, Math.ceil((bestDate - Date.now()) / 86400000)) : null;

      // Smart product detection
      let product = "Item";
      let emoji = "Package";
      if (/MILK|DAIRY/i.test(cleaned)) { product = "Milk"; emoji = "Milk"; }
      else if (/YOGURT|YOGHURT/i.test(cleaned)) { product = "Yogurt"; emoji = "Yogurt"; }
      else if (/EGG/i.test(cleaned)) { product = "Eggs"; emoji = "Egg"; }
      else if (/CHICKEN|POULTRY/i.test(cleaned)) { product = "Chicken"; emoji = "Chicken"; }
      else if (/MEDICINE|TABLET|SYRUP|CAPSULE|MG/i.test(cleaned)) { product = "Medicine"; emoji = "Pill"; }
      else if (/PASSPORT|IDENTITY|DRIVING/i.test(cleaned)) { product = "ID / Passport"; emoji = "Passport"; }

      // Result text
      let expiryMsg = "", statusMsg = "";
      if (daysLeft === null) {
        expiryMsg = "No Expiry Found";
        statusMsg = "Check packaging manually";
      } else if (daysLeft === 0) {
        expiryMsg = "EXPIRED TODAY";
        statusMsg = "Do not consume";
      } else if (daysLeft <= 2) {
        expiryMsg = `${daysLeft} DAY${daysLeft>1?'S':''} LEFT`;
        statusMsg = "USE IMMEDIATELY!";
      } else {
        expiryMsg = `${daysLeft} days remaining`;
        statusMsg = "Safe to use";
      }

      showResult(product, expiryMsg, statusMsg, emoji, photoData);
      setTimeout(speakResult, 800);
    }

    function showResult(name, days, status, emoji, photo) {
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('productName').textContent = name;
      document.getElementById('expiryText').textContent = days;
      document.getElementById('expiryText').style.color = days.includes('EXPIRED') || days.includes('LEFT') && parseInt(days) <= 2 ? '#ff3366' : '#00ff9d';
      document.getElementById('statusText').textContent = status;
      document.getElementById('emoji').textContent = emoji;
      if (photo) document.getElementById('capturedPhoto').src = photo;

      confetti({
        particleCount: 800,
        spread: 120,
        origin: { y: 0.6 },
        colors: ['#00ff9d', '#00d4ff', '#ff3366']
      });
    }

    // Pre-load voices
    speechSynthesis.onvoiceschanged = () => {};
  </script>
</body>
</html>