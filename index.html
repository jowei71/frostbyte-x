<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FrostByte AI • Zero Food Waste</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body,html { font-family:'Inter',sans-serif; background:linear-gradient(135deg,#0f172a,#1e293b); color:#f8fafc; min-height:100dvh; overflow-x:hidden; }
        .glass { background:rgba(30,41,59,0.75); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.12); }
        .scanner-line { position:absolute; width:100%; height:5px; background:#22d3ee; box-shadow:0 0 40px #22d3ee; animation:scan 3.5s infinite linear; }
        @keyframes scan { 0%{top:-10%;opacity:0} 40%{opacity:1} 100%{top:110%;opacity:0} }
        .btn-press { transition:transform .15s; }
        .btn-press:active { transform:scale(0.92); }
        .shutter { animation:shutter .15s ease; }
        @keyframes shutter { 0%,100%{background:transparent} 50%{background:white} }
        .capture-btn {
            width:84px; height:84px; background:white; border:6px solid #e2e8f0;
            border-radius:50%; position:absolute; bottom:34px; left:50%; transform:translateX(-50%);
            z-index:30; cursor:pointer; box-shadow:0 12px 40px rgba(0,0,0,0.5);
        }
        .hidden { display:none!important; }
        .pulse { animation:pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
    </style>
</head>
<body class="pb-10">

    <!-- Banner -->
    <div class="fixed top-0 left-0 right-0 z-50 text-center py-4 bg-gradient-to-r from-cyan-600 to-blue-700 text-white font-black shadow-2xl">
        FrostByte AI • REAL OCR • 100% WORKING
    </div>

    <!-- Nav -->
    <nav class="glass fixed top-14 left-0 right-0 z-40 px-5 py-4 flex justify-between items-center hidden md:flex">
        <div class="flex items-center gap-4">
            <div class="w-11 h-11 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-2xl flex items-center justify-center">
                <i class="fa-solid fa-snowflake text-white text-xl"></i>
            </div>
            <h1 class="text-2xl font-black">FrostByte<span class="text-cyan-400">.ai</span></h1>
        </div>
        <div class="bg-emerald-500/20 border border-emerald-500/40 px-4 py-2 rounded-full text-emerald-400 font-bold flex items-center gap-2">
            <div class="w-3 h-3 bg-emerald-400 rounded-full pulse"></div>
            LIVE AI
        </div>
    </nav>

    <main class="pt-24 px-5 max-w-xl mx-auto">

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-5 mb-8">
            <div class="glass rounded-3xl p-6 text-center">
                <p class="text-slate-400 text-sm mb-2">Fridge Health</p>
                <p class="text-5xl font-black text-emerald-400" id="health">--</p>
            </div>
            <div class="glass rounded-3xl p-6 text-center">
                <p class="text-slate-400 text-sm mb-2">Money Saved</p>
                <p class="text-5xl font-black text-amber-400">$<span id="saved">0.0</span></p>
            </div>
        </div>

        <!-- Scanner Box -->
        <div class="glass rounded-3xl p-2 shadow-2xl mb-8">
            <div class="bg-slate-900/95 rounded-3xl overflow-hidden relative h-96">

                <!-- Start Screen -->
                <div id="start" class="absolute inset-0 flex flex-col items-center justify-center p-10 text-center space-y-10">
                    <div class="w-36 h-36 bg-gradient-to-br from-cyan-600/30 to-blue-700/30 rounded-full flex items-center justify-center border-4 border-dashed border-cyan-500/50 pulse">
                        <i class="fa-solid fa-camera text-7xl text-cyan-400"></i>
                    </div>
                    <div>
                        <h2 class="text-4xl font-black mb-3">Scan Any Food</h2>
                        <p class="text-slate-400 text-lg">Milk • Yogurt • Meat • Medicine • Everything</p>
                    </div>
                    <button id="open-cam" class="w-full py-6 bg-gradient-to-r from-cyan-600 to-blue-700 rounded-2xl text-white font-black text-2xl shadow-2xl btn-press">
                        OPEN CAMERA
                    </button>
                </div>

                <!-- Camera View -->
                <div id="cam" class="hidden absolute inset-0">
                    <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
                    <div class="scanner-line"></div>
                    <button id="capture" class="capture-btn"></button>
                    <button onclick="location.reload()" class="absolute top-5 right-5 w-14 h-14 bg-black/70 rounded-full flex items-center justify-center text-3xl text-white z-40">
                        ×
                    </button>
                </div>

                <!-- Processing -->
                <div id="processing" class="hidden absolute inset-0 bg-black flex flex-col items-center justify-center p-10 text-center">
                    <div class="scanner-line"></div>
                    <i class="fa-solid fa-brain text-8xl text-cyan-400 mb-10 animate-pulse"></i>
                    <p class="text-3xl font-black text-cyan-400">Reading expiry date...</p>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden space-y-6">
            <h2 class="text-3xl font-black text-center mb-6">Your Fridge</h2>
            <div id="grid" class="grid grid-cols-1 gap-6"></div>
        </div>
    </main>

    <audio id="click" src="https://assets.mixkit.co/sfx/preview/mixkit-camera-shutter-click-564.mp3" preload="auto"></audio>

    <script>
        let stream = null;
        let worker = null;
        let inventory = JSON.parse(localStorage.getItem('fb-inv') || '[]');
        let money = parseFloat(localStorage.getItem('fb-money') || '0');

        const video = document.getElementById('video');
        const grid = document.getElementById('grid');
        const healthEl = document.getElementById('health');
        const moneyEl = document.getElementById('saved');

        // Update money display
        moneyEl.textContent = money.toFixed(1);

        // Open camera
        document.getElementById('open-cam').onclick = async () => {
            document.getElementById('start').classList.add('hidden');
            document.getElementById('cam').classList.remove('hidden');

            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" , width: {ideal:1920}, height: {ideal:1080}
            });
            video.srcObject = stream;
            video.play();
        };

        // CAPTURE BUTTON — NOW 100% WORKING
        document.getElementById('capture').onclick = async () => {
            // Sound + Flash + Vibration
            document.getElementById('click').play().catch(()=>{});
            document.body.classList.add('shutter');
            setTimeout(() => document.body.classList.remove('shutter'), 150);
            if ('vibrate' in navigator) navigator.vibrate([100]);

            // Capture image
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

            // Stop camera
            stream.getTracks().forEach(t => t.stop());
            document.getElementById('cam').classList.add('hidden');
            document.getElementById('processing').classList.remove('hidden');

            // OCR
            worker = worker || await Tesseract.createWorker('eng');
            const { data: { text } } = await worker.recognize(canvas);

            // Find dates
            const dates = text.match(/\d{1,2}[\/\-\.\s]\d{1,2}[\/\-\.\s]\d{2,4}|\d{4}[\/\-\.\s]\d{2}[\/\-\.\s]\d{2}|(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)[\s\.\/\-]?\d{1,2}[\s\,]?\d{2,4}/gi) || [];
            let expiry = null;
            if (dates.length > 0) {
                for (let d of dates) {
                    const parsed = new Date(d);
                    if (!isNaN(parsed) && parsed > new Date('2020')) {
                        expiry = parsed;
                        break;
                    }
                }
            }

            const daysLeft = expiry ? Math.max(0, Math.ceil((expiry - new Date()) / 86400000)) : 10;
            const name = guessName(text);
            const emoji = getEmoji(name);

            const item = { name, daysLeft, emoji, added: new Date().toISOString() };
            inventory.unshift(item);
            localStorage.setItem('fb-inv', JSON.stringify(inventory));

            render();
            document.getElementById('processing').classList.add('hidden');
            confetti({ particleCount: 400, spread: 120, origin: { y: 0.55 } });
        };

        function guessName(text) {
            const map = {
                milk:"Milk", yogurt:"Yogurt", cheese:"Cheese", chicken:"Chicken", egg:"Eggs",
                bread:"Bread", pizza:"Pizza", banana:"Banana", avocado:"Avocado", tomato:"Tomato"
            };
            text = text.toLowerCase();
            for (let key in map) {
                if (text.includes(key)) return map[key];
            }
            return "Food Item";
        }

        function getEmoji(name) {
            const emojis = { Milk:"Milk", Yogurt:"Yogurt", Cheese:"Cheese", Chicken:"Chicken", Eggs:"Eggs", Pizza:"Pizza", Banana:"Banana" };
            return emojis[name] || "Package";
        }

        function render() {
            document.getElementById('results').classList.remove('hidden');
            grid.innerHTML = '';

            let total = 0;
            inventory.forEach((item, i) => {
                total += item.daysLeft > 10 ? 100 : item.daysLeft > 5 ? 75 : item.daysLeft > 2 ? 40 : 10;
                const color = item.daysLeft <= 1 ? 'bg-red-600/30 border-red-500/50 text-red-400' :
                             item.daysLeft <= 3 ? 'bg-orange-600/30 border-orange-500/50 text-orange-400' :
                             'bg-emerald-600/30 border-emerald-500/50 text-emerald-400';

                grid.innerHTML += `
                    <div class="glass rounded-3xl p-7 border ${color} text-center">
                        <div class="text-8xl mb-6">${item.emoji}</div>
                        <h3 class="text-2xl font-black mb-3">${item.name}</h3>
                        <div class="text-5xl font-black mb-6 ${item.daysLeft<=3?'text-red-400':''}">${item.daysLeft}<span class="text-2xl">DAYS</span></div>
                        <button onclick="eatItem(${i})" class="w-full py-5 bg-white/15 hover:bg-white/25 rounded-2xl font-black text-xl btn-press">
                            Mark Eaten (+$3.50)
                        </button>
                    </div>`;
            });

            const health = inventory.length ? Math.round(total / inventory.length) : 0;
            healthEl.textContent = health;
            grid.scrollIntoView({ behavior: 'smooth' });
        }

        window.eatItem = (i) => {
            money += 3.5;
            localStorage.setItem('fb-money', money);
            moneyEl.textContent = money.toFixed(1);
            inventory.splice(i, 1);
            localStorage.setItem('fb-inv', JSON.stringify(inventory));
            render();
            confetti({ particleCount: 150 });
            if ('vibrate' in navigator) navigator.vibrate([80,50,80]);
        };

        // Load existing data
        if (inventory.length) render();
    </script>
</body>
</html>