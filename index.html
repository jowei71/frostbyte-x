<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FrostByte AI ‚Ä¢ Smart Expiry Tracker</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="AI-powered expiry date tracking to eliminate food waste. Never miss an expiration date again.">
    
    <!-- Styles & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #22d3ee;
            box-shadow: 0 0 20px #22d3ee;
            animation: scan 3s infinite linear;
        }
        
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            40% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-press {
            transition: all 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-press:active {
            transform: scale(0.95);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 5px rgba(34, 211, 238, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 211, 238, 0.8); }
            100% { box-shadow: 0 0 5px rgba(34, 211, 238, 0.5); }
        }
        
        .loading-dots:after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .ai-pulse {
            animation: aiPulse 3s ease-in-out infinite;
        }

        @keyframes aiPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        #preview-canvas {
            border-radius: 20px;
            max-width: 100%;
        }

        .api-status {
            transition: all 0.3s ease;
        }

        .api-status.connected {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
            color: #4ade80;
        }

        .api-status.error {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #f87171;
        }

        /* Expiry specific styles */
        .expiry-critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(225, 29, 72, 0.2) 100%);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .expiry-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.2) 100%);
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .expiry-safe {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.2) 100%);
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .expiry-fresh {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(14, 165, 233, 0.2) 100%);
            border: 1px solid rgba(6, 182, 212, 0.4);
        }

        .countdown-timer {
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }

        .urgency-pulse {
            animation: urgencyPulse 2s ease-in-out infinite;
        }

        @keyframes urgencyPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Voice Assistant Styles */
        .voice-assistant {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 40;
        }

        .voice-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22d3ee 0%, #0ea5e9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(34, 211, 238, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(34, 211, 238, 0.6);
        }

        .voice-btn.listening {
            animation: voicePulse 1.5s infinite;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        @keyframes voicePulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .voice-response {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 300px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .voice-response.show {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .voice-text {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .voice-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-text-lg {
                font-size: 1.125rem;
            }
            
            .voice-assistant {
                bottom: 16px;
                right: 16px;
            }
            
            .voice-btn {
                width: 56px;
                height: 56px;
            }
            
            .voice-response {
                width: 280px;
                right: -20px;
            }
        }

        /* Progress bar animations */
        .progress-bar {
            transition: width 1s ease-in-out;
        }

        .expiry-badge {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen pb-8">
    <!-- Navigation -->
    <nav class="glass fixed top-0 w-full z-50 px-4 py-3 flex justify-between items-center border-b border-white/10">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl flex items-center justify-center">
                <i class="fa-solid fa-clock text-white text-sm"></i>
            </div>
            <h1 class="text-lg font-bold">FrostByte<span class="text-cyan-400">.ai</span></h1>
        </div>
        <div id="api-status" class="api-status text-xs bg-emerald-500/20 border border-emerald-500/40 px-2 py-1 rounded-full text-emerald-400 flex items-center gap-2">
            <div class="w-1.5 h-1.5 bg-emerald-400 rounded-full pulse-glow"></div>
            AI CONNECTED
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-16 px-4 max-w-4xl mx-auto">
        <!-- Expiry Overview Cards -->
        <div class="stats-grid mb-6">
            <div class="glass rounded-2xl p-4 relative overflow-hidden fade-in">
                <div class="absolute -right-6 -top-6 w-20 h-20 bg-red-500/10 rounded-full blur-xl"></div>
                <div class="text-xs text-slate-400 mb-1">Expiring Today</div>
                <div class="text-3xl font-bold text-red-400" id="expiring-today">0</div>
                <div class="text-xs text-slate-500 mt-1">Urgent action needed</div>
            </div>
            
            <div class="glass rounded-2xl p-4 relative overflow-hidden fade-in">
                <div class="absolute -right-6 -top-6 w-20 h-20 bg-amber-500/10 rounded-full blur-xl"></div>
                <div class="text-xs text-slate-400 mb-1">Expiring This Week</div>
                <div class="text-3xl font-bold text-amber-400" id="expiring-week">0</div>
                <div class="text-xs text-slate-500 mt-1">Plan to use soon</div>
            </div>

            <div class="glass rounded-2xl p-4 relative overflow-hidden fade-in">
                <div class="absolute -right-6 -top-6 w-20 h-20 bg-emerald-500/10 rounded-full blur-xl"></div>
                <div class="text-xs text-slate-400 mb-1">Fresh Items</div>
                <div class="text-3xl font-bold text-emerald-400" id="fresh-items">0</div>
                <div class="text-xs text-slate-500 mt-1">Good for 2+ weeks</div>
            </div>
        </div>

        <!-- Scanner Section -->
        <div class="glass rounded-3xl p-1 mb-6 border border-white/10 shadow-xl shadow-black/30 fade-in ai-pulse">
            <div class="bg-slate-900/80 rounded-[1.5rem] overflow-hidden relative min-h-[350px] flex flex-col items-center justify-center">
                
                <!-- Initial State -->
                <div id="scanner-init" class="text-center p-6 w-full space-y-6">
                    <div class="w-24 h-24 bg-slate-800/60 rounded-full mx-auto flex items-center justify-center border-4 border-dashed border-cyan-500/40 relative pulse-glow">
                        <i class="fa-solid fa-camera text-4xl text-cyan-400"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-2 mobile-text-lg">Scan Expiry Dates</h3>
                        <p class="text-slate-400 text-sm max-w-xs mx-auto">AI-powered expiry tracking ‚Ä¢ Never waste food again</p>
                    </div>
                    
                    <div class="space-y-3 w-full max-w-xs mx-auto">
                        <button id="modern-camera-btn" class="w-full px-4 py-4 bg-gradient-to-r from-cyan-600 to-blue-700 rounded-xl text-white font-semibold text-base btn-press flex items-center justify-center gap-2">
                            <i class="fa-solid fa-camera"></i>
                            Scan Food Items
                        </button>
                        
                        <button id="upload-btn" class="w-full px-4 py-4 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-semibold text-base btn-press flex items-center justify-center gap-2">
                            <i class="fa-solid fa-images"></i>
                            Upload Fridge Photo
                        </button>
                        
                        <button id="demo-btn" class="w-full px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-white font-medium btn-press text-sm">
                            Try Expiry Demo
                        </button>
                    </div>
                </div>

                <!-- Scanning Overlay -->
                <div id="scanning-overlay" class="hidden absolute inset-0 bg-black z-20 rounded-[1.5rem]">
                    <canvas id="preview-canvas" class="w-full h-full object-cover opacity-40"></canvas>
                    <div class="scanner-line"></div>
                    
                    <div class="absolute inset-0 flex flex-col items-center justify-center gap-4 p-4">
                        <div class="w-16 h-16 bg-cyan-500/20 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-microchip fa-spin text-3xl text-cyan-400"></i>
                        </div>
                        
                        <div class="glass border border-cyan-500/30 px-4 py-3 rounded-2xl max-w-xs">
                            <p class="text-lg font-bold text-cyan-400 text-center" id="scan-text">Analyzing Expiry Dates<span class="loading-dots"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden file inputs -->
        <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
        <input type="file" id="gallery-input" accept="image/*" class="hidden">
        
        <!-- Results Section -->
        <div id="results-section" class="hidden space-y-6 fade-in">
            <!-- Urgent Expiry Alert -->
            <div id="urgent-alert" class="hidden glass expiry-critical rounded-2xl p-4 urgency-pulse">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-red-500/20 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-triangle-exclamation text-red-400"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-red-400">Urgent Expiry Alert!</h3>
                        <p class="text-slate-300 text-sm">You have <span id="urgent-count">0</span> items expiring within 24 hours</p>
                    </div>
                    <button id="urgent-action" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-xl text-white font-semibold text-sm">
                        View Now
                    </button>
                </div>
            </div>

            <!-- Expiry Timeline -->
            <div class="glass rounded-2xl p-4">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-calendar-clock text-cyan-400"></i>
                    Expiry Timeline
                </h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-400">Today</span>
                        <span class="text-sm text-slate-400">1 Week</span>
                        <span class="text-sm text-slate-400">2 Weeks+</span>
                    </div>
                    <div class="w-full bg-slate-700/50 h-3 rounded-full overflow-hidden">
                        <div class="h-full flex">
                            <div id="timeline-today" class="bg-red-500 transition-all duration-1000 ease-out" style="width: 0%"></div>
                            <div id="timeline-week" class="bg-amber-500 transition-all duration-1000 ease-out" style="width: 0%"></div>
                            <div id="timeline-fresh" class="bg-emerald-500 transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Buttons -->
            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button class="filter-btn active px-4 py-2.5 rounded-xl bg-cyan-600 border border-cyan-500 text-white text-sm font-semibold whitespace-nowrap min-w-[80px]" data-filter="all">All Items</button>
                <button class="filter-btn px-4 py-2.5 rounded-xl bg-red-500/20 border border-red-500/40 text-red-400 text-sm font-semibold whitespace-nowrap min-w-[80px]" data-filter="urgent">Urgent</button>
                <button class="filter-btn px-4 py-2.5 rounded-xl bg-amber-500/20 border border-amber-500/40 text-amber-400 text-sm font-semibold whitespace-nowrap min-w-[80px]" data-filter="warning">This Week</button>
                <button class="filter-btn px-4 py-2.5 rounded-xl bg-emerald-500/20 border border-emerald-500/40 text-emerald-400 text-sm font-semibold whitespace-nowrap min-w-[80px]" data-filter="fresh">Fresh</button>
            </div>
            
            <!-- Items Grid -->
            <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>

        <!-- Expiry Features Section -->
        <div class="py-8">
            <h2 class="text-2xl font-bold text-center mb-6">Smart Expiry Protection</h2>
            <div class="space-y-3">
                <div class="glass rounded-2xl p-4 card-hover">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl flex items-center justify-center text-white flex-shrink-0">
                            <i class="fa-solid fa-bell"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-1">Smart Alerts</h3>
                            <p class="text-slate-400 text-sm">Get notified before food expires</p>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-2xl p-4 card-hover">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center text-white flex-shrink-0">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-1">Expiry Forecasting</h3>
                            <p class="text-slate-400 text-sm">AI predicts when food will go bad</p>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-2xl p-4 card-hover">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center text-white flex-shrink-0">
                            <i class="fa-solid fa-lightbulb"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-1">Usage Suggestions</h3>
                            <p class="text-slate-400 text-sm">Smart ideas for expiring items</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Voice Assistant -->
    <div class="voice-assistant">
        <div class="voice-response" id="voice-response">
            <div class="voice-text" id="voice-text">Hello! I'm your FrostByte assistant. How can I help with your food items today?</div>
            <div class="voice-actions">
                <button class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs text-slate-300" id="voice-close">Close</button>
                <button class="px-3 py-1 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-xs text-white" id="voice-repeat">Repeat</button>
            </div>
        </div>
        <div class="voice-btn" id="voice-btn">
            <i class="fa-solid fa-microphone text-white text-xl" id="voice-icon"></i>
        </div>
    </div>
    
    <!-- Recipe Modal -->
    <div id="recipe-modal" class="fixed inset-0 z-50 hidden items-end justify-center bg-black/60 backdrop-blur-sm">
        <div class="w-full max-w-2xl bg-slate-900 rounded-t-3xl border-t border-white/10 max-h-[80vh] overflow-hidden">
            <div class="p-4">
                <div class="w-12 h-1 bg-slate-600 rounded-full mx-auto mb-4"></div>
                <div id="recipe-content" class="text-center space-y-4">
                    <i class="fa-solid fa-microchip fa-spin text-4xl text-cyan-500"></i>
                    <p class="text-base text-slate-400">Finding recipes for expiring items<span class="loading-dots"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        let inventory = [];
        let savedMoney = 0;
        let isListening = false;
        let recognition = null;
        
        // Gemini AI Configuration
        const GEMINI_API_KEY = 'AIzaSyDsCdnq-KeB9CJ2HlQaxrqzuGo-YOAz09Q';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        // DOM Elements
        const scannerInit = document.getElementById('scanner-init');
        const scanningOverlay = document.getElementById('scanning-overlay');
        const resultsSection = document.getElementById('results-section');
        const cameraInput = document.getElementById('camera-input');
        const galleryInput = document.getElementById('gallery-input');
        const modernCameraBtn = document.getElementById('modern-camera-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const demoBtn = document.getElementById('demo-btn');
        const itemsGrid = document.getElementById('items-grid');
        const expiringToday = document.getElementById('expiring-today');
        const expiringWeek = document.getElementById('expiring-week');
        const freshItems = document.getElementById('fresh-items');
        const urgentAlert = document.getElementById('urgent-alert');
        const urgentCount = document.getElementById('urgent-count');
        const urgentAction = document.getElementById('urgent-action');
        const timelineToday = document.getElementById('timeline-today');
        const timelineWeek = document.getElementById('timeline-week');
        const timelineFresh = document.getElementById('timeline-fresh');
        const scanText = document.getElementById('scan-text');
        const recipeModal = document.getElementById('recipe-modal');
        const recipeContent = document.getElementById('recipe-content');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const previewCanvas = document.getElementById('preview-canvas');
        const apiStatus = document.getElementById('api-status');
        const voiceBtn = document.getElementById('voice-btn');
        const voiceResponse = document.getElementById('voice-response');
        const voiceText = document.getElementById('voice-text');
        const voiceClose = document.getElementById('voice-close');
        const voiceRepeat = document.getElementById('voice-repeat');
        const voiceIcon = document.getElementById('voice-icon');
        
        // Enhanced Demo Data with realistic expiry dates
        const demoItems = [
            { name: "Whole Milk", daysLeft: 1, emoji: "ü•õ", tip: "Use today or freeze", category: "dairy", addedDate: new Date() },
            { name: "Avocado", daysLeft: 0, emoji: "ü•ë", tip: "Ripe - eat immediately", category: "produce", addedDate: new Date() },
            { name: "Salmon Fillet", daysLeft: 2, emoji: "üêü", tip: "Cook within 48 hours", category: "meat", addedDate: new Date() },
            { name: "Baby Spinach", daysLeft: 3, emoji: "ü•¨", tip: "Wilting - use in cooking", category: "produce", addedDate: new Date() },
            { name: "Greek Yogurt", daysLeft: 14, emoji: "üç∂", tip: "Good until next week", category: "dairy", addedDate: new Date() },
            { name: "Cheddar Cheese", daysLeft: 21, emoji: "üßÄ", tip: "Ages well", category: "dairy", addedDate: new Date() },
            { name: "Eggs", daysLeft: 10, emoji: "ü•ö", tip: "Good for baking", category: "dairy", addedDate: new Date() },
            { name: "Bell Peppers", daysLeft: 6, emoji: "ü´ë", tip: "Use in meals this week", category: "produce", addedDate: new Date() }
        ];

        // Voice Commands
        const voiceCommands = {
            "scan": { 
                action: () => modernCameraBtn.click(), 
                response: "Opening camera to scan your food items." 
            },
            "upload": { 
                action: () => uploadBtn.click(), 
                response: "Opening gallery to upload a fridge photo." 
            },
            "demo": { 
                action: () => demoBtn.click(), 
                response: "Loading the demo with sample food items." 
            },
            "urgent": { 
                action: () => filterItems('urgent'), 
                response: "Showing items that need urgent attention." 
            },
            "fresh": { 
                action: () => filterItems('fresh'), 
                response: "Showing your fresh items that are good for a while." 
            },
            "help": { 
                action: () => showVoiceResponse("You can say: 'scan' to scan items, 'upload' to upload a photo, 'demo' for a demo, 'urgent' to see expiring items, or 'fresh' to see items that are still good."), 
                response: "Here are the commands you can use." 
            },
            "hello": { 
                action: () => showVoiceResponse("Hello! I'm your FrostByte assistant. I can help you track food expiry dates and reduce waste."), 
                response: "Hello! I'm your FrostByte assistant." 
            }
        };

        // Initialize Voice Recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isListening = true;
                    voiceBtn.classList.add('listening');
                    voiceIcon.className = 'fa-solid fa-circle-stop text-white text-xl';
                    showVoiceResponse("Listening...");
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    console.log('Voice command:', transcript);
                    
                    let commandMatched = false;
                    for (const [command, data] of Object.entries(voiceCommands)) {
                        if (transcript.includes(command)) {
                            data.action();
                            showVoiceResponse(data.response);
                            commandMatched = true;
                            break;
                        }
                    }
                    
                    if (!commandMatched) {
                        showVoiceResponse("I didn't understand that command. Try saying 'help' to see available commands.");
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    voiceIcon.className = 'fa-solid fa-microphone text-white text-xl';
                    
                    if (event.error === 'not-allowed') {
                        showVoiceResponse("Microphone access is blocked. Please allow microphone access to use voice commands.");
                    } else {
                        showVoiceResponse("Sorry, I didn't catch that. Please try again.");
                    }
                };
                
                recognition.onend = function() {
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    voiceIcon.className = 'fa-solid fa-microphone text-white text-xl';
                };
            } else {
                voiceBtn.style.display = 'none';
                console.log('Speech recognition not supported');
            }
        }

        // Voice Response Functions
        function showVoiceResponse(text) {
            voiceText.textContent = text;
            voiceResponse.classList.add('show');
            
            // Use speech synthesis to speak the response
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            }
            
            // Auto-hide after 5 seconds if not interacted with
            setTimeout(() => {
                if (voiceResponse.classList.contains('show')) {
                    voiceResponse.classList.remove('show');
                }
            }, 5000);
        }

        function toggleListening() {
            if (!recognition) return;
            
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting speech recognition:', error);
                }
            }
        }

        // Event Listeners for Voice
        voiceBtn.addEventListener('click', toggleListening);
        voiceClose.addEventListener('click', () => {
            voiceResponse.classList.remove('show');
        });
        voiceRepeat.addEventListener('click', () => {
            const text = voiceText.textContent;
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            }
        });

        // Test API Connection on Load
        async function testAPIConnection() {
            try {
                const testPrompt = {
                    contents: [{
                        parts: [{
                            text: "Say 'API Connected Successfully' in JSON format: {\"status\": \"connected\", \"message\": \"string\"}"
                        }]
                    }]
                };

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPrompt)
                });

                if (response.ok) {
                    apiStatus.innerHTML = '<div class="w-1.5 h-1.5 bg-emerald-400 rounded-full pulse-glow"></div>AI CONNECTED';
                    apiStatus.className = 'api-status connected text-xs px-2 py-1 rounded-full flex items-center gap-2';
                    console.log('‚úÖ Gemini API Connected Successfully');
                } else {
                    throw new Error('API response not OK');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è API Test Failed, using demo mode:', error);
                apiStatus.innerHTML = '<div class="w-1.5 h-1.5 bg-amber-400 rounded-full pulse-glow"></div>DEMO MODE';
                apiStatus.className = 'api-status error text-xs px-2 py-1 rounded-full flex items-center gap-2';
            }
        }

        // Event Listeners
        modernCameraBtn.addEventListener('click', () => cameraInput.click());
        uploadBtn.addEventListener('click', () => galleryInput.click());
        demoBtn.addEventListener('click', loadDemo);
        urgentAction.addEventListener('click', () => filterItems('urgent'));
        
        // File input handlers
        cameraInput.addEventListener('change', handleImageSelection);
        galleryInput.addEventListener('change', handleImageSelection);
        
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => {
                    b.classList.remove('active', 'bg-cyan-600', 'text-white');
                    b.classList.add('text-slate-300');
                });
                btn.classList.add('active', 'bg-cyan-600', 'text-white');
                btn.classList.remove('text-slate-300');
                filterItems(btn.dataset.filter);
            });
        });

        // Modern Image Handler
        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Reset inputs
            cameraInput.value = '';
            galleryInput.value = '';
            
            processImage(file);
        }

        async function processImage(file) {
            // Show scanning overlay immediately
            scanningOverlay.classList.remove('hidden');
            
            // Draw image to preview canvas
            const img = new Image();
            const ctx = previewCanvas.getContext('2d');
            
            img.onload = function() {
                // Scale canvas for mobile performance
                const maxWidth = Math.min(800, window.innerWidth);
                const scale = maxWidth / img.width;
                previewCanvas.width = maxWidth;
                previewCanvas.height = img.height * scale;
                
                ctx.drawImage(img, 0, 0, previewCanvas.width, previewCanvas.height);
                
                startScanningAnimation();
                
                // Use REAL AI analysis with fallback
                analyzeImageWithAI(file)
                    .then(aiResults => {
                        inventory = aiResults;
                        finishProcessing();
                    })
                    .catch(error => {
                        console.error('AI analysis failed, using demo data:', error);
                        inventory = [...demoItems];
                        finishProcessing();
                    });
            };
            
            img.src = URL.createObjectURL(file);
        }

        // REAL AI SCANNING FUNCTION - Focused on Expiry
        async function analyzeImageWithAI(file) {
            try {
                // Convert image to base64 for API
                const base64Image = await fileToBase64(file);
                
                // AI Prompt focused on expiry dates
                const prompt = {
                    contents: [{
                        parts: [{
                            text: `Analyze this fridge/food image and identify all visible food items. For each item, estimate days until expiration based on visual freshness cues, packaging, and typical shelf life. Return ONLY a valid JSON array in this exact format:
                            
                            [
                              {
                                "name": "Item Name",
                                "daysLeft": number,
                                "emoji": "relevant food emoji",
                                "tip": "short storage/usage tip",
                                "category": "food category"
                              }
                            ]
                            
                            Rules:
                            - Be VERY accurate about expiry dates
                            - Consider visual freshness (color, texture)
                            - Account for packaging type (opened/unopened)
                            - Return realistic expiry estimates
                            - Focus on items that will expire soonest
                            - Return max 8 items
                            - Ensure valid JSON format`
                        }, {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64Image
                            }
                        }]
                    }]
                };

                console.log('üöÄ Sending expiry analysis request to Gemini API...');
                
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(prompt)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0].content.parts[0].text) {
                    throw new Error('Invalid API response format');
                }

                const responseText = data.candidates[0].content.parts[0].text;
                console.log('üì® Raw AI Response:', responseText);
                
                // Extract JSON from response
                const jsonMatch = responseText.match(/\[[\s\S]*\]/);
                if (!jsonMatch) {
                    throw new Error('No valid JSON found in response');
                }

                const items = JSON.parse(jsonMatch[0]);
                console.log('‚úÖ AI Expiry Analysis Successful:', items);
                
                // Validate and clean up the response
                return items.map(item => ({
                    name: item.name || 'Unknown Food',
                    daysLeft: Math.max(0, Math.min(30, item.daysLeft || 7)),
                    emoji: item.emoji || 'üçΩÔ∏è',
                    tip: item.tip || 'Use soon',
                    category: item.category || 'general',
                    addedDate: new Date()
                })).slice(0, 8);

            } catch (error) {
                console.error('‚ùå AI Expiry Analysis Error:', error);
                throw error;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function finishProcessing() {
            renderItems();
            scanningOverlay.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            
            // Voice announcement
            const urgentItems = inventory.filter(item => item.daysLeft <= 1).length;
            if (urgentItems > 0) {
                showVoiceResponse(`Scan complete! I found ${urgentItems} items that need immediate attention.`);
            } else {
                showVoiceResponse("Scan complete! All your items look good for now.");
            }
            
            // Smooth scroll to results
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            confetti({
                particleCount: 80,
                spread: 50,
                origin: { y: 0.6 }
            });
        }
        
        function startScanningAnimation() {
            const messages = [
                "Scanning expiry dates...",
                "Checking food freshness...",
                "Analyzing packaging...",
                "Estimating shelf life...",
                "Gemini AI processing..."
            ];
            
            let i = 0;
            const interval = setInterval(() => {
                scanText.innerHTML = `Analyzing Expiry Dates<span class="loading-dots"></span>`;
                setTimeout(() => {
                    scanText.innerHTML = `${messages[i]}<span class="loading-dots"></span>`;
                    i = (i + 1) % messages.length;
                }, 100);
            }, 800);
            
            // Clear interval when processing finishes
            setTimeout(() => clearInterval(interval), 5000);
        }
        
        function loadDemo() {
            // Show loading state on demo button
            const originalText = demoBtn.innerHTML;
            demoBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading Demo...';
            demoBtn.disabled = true;
            
            // Simulate AI processing
            scanningOverlay.classList.remove('hidden');
            startScanningAnimation();
            
            setTimeout(() => {
                inventory = [...demoItems];
                renderItems();
                scanningOverlay.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                
                // Reset button
                demoBtn.innerHTML = originalText;
                demoBtn.disabled = false;
                
                // Voice announcement
                showVoiceResponse("Demo loaded! You have 8 sample food items with different expiry dates.");
                
                // Smooth scroll to results
                setTimeout(() => {
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                confetti({
                    particleCount: 60,
                    spread: 40,
                    origin: { y: 0.6 }
                });
            }, 3000);
        }
        
        function renderItems() {
            let totalScore = 0;
            itemsGrid.innerHTML = '';
            
            if (inventory.length === 0) {
                itemsGrid.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fa-solid fa-face-frown text-4xl text-slate-600 mb-3"></i>
                        <p class="text-slate-400 text-sm">No items detected. Try another photo.</p>
                    </div>
                `;
                return;
            }
            
            // Calculate expiry statistics
            let todayCount = 0;
            let weekCount = 0;
            let freshCount = 0;
            let urgentCount = 0;
            
            inventory.forEach((item, index) => {
                // Count items by expiry category
                if (item.daysLeft <= 0) {
                    todayCount++;
                    urgentCount++;
                } else if (item.daysLeft <= 2) {
                    todayCount++;
                    urgentCount++;
                } else if (item.daysLeft <= 7) {
                    weekCount++;
                } else {
                    freshCount++;
                }
            });
            
            // Update statistics
            expiringToday.textContent = todayCount;
            expiringWeek.textContent = weekCount;
            freshItems.textContent = freshCount;
            
            // Update urgent alert
            if (urgentCount > 0) {
                urgentCount.textContent = urgentCount;
                urgentAlert.classList.remove('hidden');
            } else {
                urgentAlert.classList.add('hidden');
            }
            
            // Update timeline
            const totalItems = inventory.length;
            timelineToday.style.width = `${(todayCount / totalItems) * 100}%`;
            timelineWeek.style.width = `${(weekCount / totalItems) * 100}%`;
            timelineFresh.style.width = `${(freshCount / totalItems) * 100}%`;
            
            // Render items
            inventory.forEach((item, index) => {
                let expiryClass, textColor, badgeColor, urgencyText, progressColor, progressWidth;
                
                if (item.daysLeft <= 1) {
                    expiryClass = 'expiry-critical';
                    textColor = 'text-red-400';
                    badgeColor = 'bg-red-500';
                    urgencyText = 'URGENT';
                    progressColor = 'bg-red-500';
                    progressWidth = '100%';
                    totalScore += 5;
                } else if (item.daysLeft <= 3) {
                    expiryClass = 'expiry-critical';
                    textColor = 'text-red-400';
                    badgeColor = 'bg-red-500';
                    urgencyText = 'SOON';
                    progressColor = 'bg-red-400';
                    progressWidth = '85%';
                    totalScore += 15;
                } else if (item.daysLeft <= 7) {
                    expiryClass = 'expiry-warning';
                    textColor = 'text-amber-400';
                    badgeColor = 'bg-amber-500';
                    urgencyText = 'THIS WEEK';
                    progressColor = 'bg-amber-500';
                    progressWidth = '60%';
                    totalScore += 40;
                } else {
                    expiryClass = 'expiry-fresh';
                    textColor = 'text-emerald-400';
                    badgeColor = 'bg-emerald-500';
                    urgencyText = 'FRESH';
                    progressColor = 'bg-emerald-500';
                    progressWidth = '30%';
                    totalScore += 80;
                }
                
                const itemCard = document.createElement('div');
                itemCard.className = `glass rounded-2xl p-4 ${expiryClass} card-hover`;
                itemCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${item.emoji}</div>
                            <div>
                                <h4 class="font-semibold text-white">${item.name}</h4>
                                <p class="text-xs text-slate-400">${item.category}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400 mb-1">Expires in</div>
                            <div class="countdown-timer font-bold ${textColor}">${item.daysLeft} day${item.daysLeft !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span>Freshness</span>
                            <span>${urgencyText}</span>
                        </div>
                        <div class="w-full bg-slate-700/50 h-2 rounded-full overflow-hidden">
                            <div class="h-full ${progressColor} progress-bar" style="width: ${progressWidth}"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-slate-300">${item.tip}</div>
                        <button class="recipe-btn px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs text-slate-300" data-index="${index}">
                            <i class="fa-solid fa-utensils mr-1"></i>Recipes
                        </button>
                    </div>
                `;
                
                itemsGrid.appendChild(itemCard);
            });
            
            // Add event listeners to recipe buttons
            document.querySelectorAll('.recipe-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    showRecipeModal(inventory[index]);
                });
            });
        }
        
        function filterItems(filter) {
            const items = document.querySelectorAll('.glass.rounded-2xl.p-4');
            
            items.forEach(item => {
                const daysLeftText = item.querySelector('.countdown-timer').textContent;
                const daysLeft = parseInt(daysLeftText);
                
                let showItem = false;
                
                switch(filter) {
                    case 'all':
                        showItem = true;
                        break;
                    case 'urgent':
                        showItem = daysLeft <= 3;
                        break;
                    case 'warning':
                        showItem = daysLeft > 3 && daysLeft <= 7;
                        break;
                    case 'fresh':
                        showItem = daysLeft > 7;
                        break;
                }
                
                item.style.display = showItem ? 'block' : 'none';
            });
        }
        
        function showRecipeModal(item) {
            recipeModal.classList.remove('hidden');
            
            // Simulate AI recipe generation
            setTimeout(() => {
                recipeContent.innerHTML = `
                    <div class="text-left space-y-4">
                        <h3 class="text-xl font-bold text-cyan-400">Recipes for ${item.name}</h3>
                        <div class="space-y-3">
                            <div class="glass rounded-xl p-3">
                                <h4 class="font-semibold text-white mb-1">Quick ${item.name} Dish</h4>
                                <p class="text-sm text-slate-300">A simple recipe to use your ${item.name.toLowerCase()} before it expires.</p>
                                <div class="flex items-center gap-2 mt-2 text-xs text-slate-400">
                                    <i class="fa-solid fa-clock"></i>
                                    <span>15 mins</span>
                                    <i class="fa-solid fa-utensils ml-2"></i>
                                    <span>Easy</span>
                                </div>
                            </div>
                            
                            <div class="glass rounded-xl p-3">
                                <h4 class="font-semibold text-white mb-1">${item.name} Salad</h4>
                                <p class="text-sm text-slate-300">Fresh salad featuring ${item.name.toLowerCase()} as the main ingredient.</p>
                                <div class="flex items-center gap-2 mt-2 text-xs text-slate-400">
                                    <i class="fa-solid fa-clock"></i>
                                    <span>10 mins</span>
                                    <i class="fa-solid fa-utensils ml-2"></i>
                                    <span>Very Easy</span>
                                </div>
                            </div>
                            
                            <div class="glass rounded-xl p-3">
                                <h4 class="font-semibold text-white mb-1">${item.name} Smoothie</h4>
                                <p class="text-sm text-slate-300">Blend ${item.name.toLowerCase()} with fruits for a nutritious drink.</p>
                                <div class="flex items-center gap-2 mt-2 text-xs text-slate-400">
                                    <i class="fa-solid fa-clock"></i>
                                    <span>5 mins</span>
                                    <i class="fa-solid fa-utensils ml-2"></i>
                                    <span>Easy</span>
                                </div>
                            </div>
                        </div>
                        
                        <button class="w-full px-4 py-3 bg-cyan-600 hover:bg-cyan-700 rounded-xl text-white font-semibold mt-4 close-modal">
                            Close Recipes
                        </button>
                    </div>
                `;
                
                // Add event listener to close button
                document.querySelector('.close-modal').addEventListener('click', () => {
                    recipeModal.classList.add('hidden');
                });
            }, 1500);
        }
        
        // Close modal when clicking outside
        recipeModal.addEventListener('click', (e) => {
            if (e.target === recipeModal) {
                recipeModal.classList.add('hidden');
            }
        });

        // Initialize the app
        function initApp() {
            testAPIConnection();
            initVoiceRecognition();
            
            // Show initial voice greeting after a short delay
            setTimeout(() => {
                showVoiceResponse("Welcome to FrostByte AI! I can help you track food expiry dates. Try saying 'scan' to scan items or 'help' for more options.");
            }, 1000);
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>