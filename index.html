<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>FrostByte X • Ultimate Scanner</title>
  <meta name="theme-color" content="#000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body,html{height:100dvh;background:#000;color:#0f0;font-family:system-ui;overflow:hidden}
    #video{width:100vw;height:100dvh;object-fit:cover}
    .line{position:fixed;top:0;left:0;right:0;height:6px;background:#0f0;box-shadow:0 0 60px #0f0;animation:s 2.8s infinite linear;z-index:10}
    @keyframes s{0%{top:-10%}100%{top:110%}}
    .btn{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);width:86px;height:86px;background:#fff;border-radius:50%;box-shadow:0 15px 50px #000;z-index:99}
    .btn:active{transform:translateX(-50%) scale(0.88)}
    .flash{animation:f 0.2s}@keyframes f{50%{background:#fff}}
    .center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100dvh;text-align:center;padding:20px}
    h1{font-size:3.8rem;font-weight:900}
    .result-box{background:rgba(0,255,0,0.1);border:2px solid #0f0;padding:30px;border-radius:30px;max-width:90%}
    .big{font-size:5rem;line-height:1}
    .hidden{display:none!important}
    button{font-weight:900}
  </style>
</head>
<body>

  <div id="start" class="center text-white">
    <h1>FROSTBYTE <span style="color:#0f0">X</span></h1>
    <p class="text-2xl mb-10">Barcode • QR • Expiry • Medicine • ID • Crypto</p>
    <button id="open" class="px-16 py-7 bg-green-500 text-black text-3xl font-black rounded-3xl shadow-2xl">START SCAN</button>
  </div>

  <div id="cam" class="hidden">
    <video id="video" autoplay playsinline muted></video>
    <div class="line"></div>
    <button id="snap" class="btn"></button>
    <button onclick="location.reload()" class="fixed top-8 right-8 text-white text-5xl z-50 bg-black/70 w-16 h-16 rounded-full">X</button>
  </div>

  <div id="result" class="hidden center text-white">
    <div class="result-box">
      <div class="text-9xl mb-8" id="icon">Package</div>
      <h2 class="text-5xl font-black mb-6" id="title">Scanning...</h2>
      <div class="text-3xl mb-8 leading-relaxed" id="details"></div>
      <div class="text-2xl mb-10 text-cyan-400" id="extra"></div>
      <button onclick="speak(document.getElementById('title').textContent + '. ' + document.getElementById('details').textContent)" class="mb-6 px-10 py-5 bg-cyan-500 text-black rounded-2xl font-black">SPEAK AGAIN</button>
      <button onclick="location.reload()" class="px-16 py-7 bg-green-500 text-black text-3xl font-black rounded-3xl">SCAN NEXT</button>
    </div>
  </div>

  <audio id="beep" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
  <audio id="shutter" src="https://assets.mixkit.co/sfx/preview/mixkit-camera-shutter-click-564.mp3" preload="auto"></audio>

  <!-- ZXing for Barcode + QR -->
  <script src="https://unpkg.com/@zxing/library@0.20.0/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script>
    let stream, worker, reader;

    document.getElementById('open').onclick = async () => {
      document.getElementById('start').classList.add('hidden');
      document.getElementById('cam').classList.remove('hidden');

      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      const video = document.getElementById('video');
      video.srcObject = stream;

      reader = new ZXing.BrowserMultiFormatReader();
      reader.decodeFromVideoDevice(null, video, (result, err) => {
        if (result) {
          document.getElementById('beep').play();
          handleCode(result.getText(), result.getFormatName());
        }
      });
    };

    document.getElementById('snap').onclick = async () => {
      document.getElementById('shutter').play();
      document.body.classList.add('flash');
      setTimeout(() => document.body.classList.remove('flash'), 200);
      if ('vibrate' in navigator) navigator.vibrate(120);

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);

      stream.getTracks().forEach(t => t.stop());
      reader?.reset();
      document.getElementById('cam').classList.add('hidden');

      worker = worker || await Tesseract.createWorker('eng');
      const { data: { text } } = await worker.recognize(canvas);
      processOCR(text);
    };

    function handleCode(code, format) {
      stream.getTracks().forEach(t => t.stop());
      reader.reset();
      document.getElementById('cam').classList.add('hidden');

      let title = "", details = "", extra = "", icon = "QR Code";

      if (format.includes("QR")) {
        if (code.includes("http")) {
          title = "QR Link Found";
          details = "Opening website...";
          extra = code;
          setTimeout(() => window.location.href = code, 2000);
        } else if (/^[A-Za-z2-7]{8,90}$/.test(code)) {
          title = "CRYPTO SEED!";
          details = "NEVER SHARE THIS!";
          extra = "12-24 word recovery phrase detected";
          icon = "Lock";
        } else {
          title = "QR Code Scanned";
          details = code.length > 100 ? code.substring(0,100)+"..." : code;
        }
      } else {
        title = "Barcode Found";
        details = code;
        extra = format;
      }

      showResult(title, details, extra, icon);
      speak(title + ". " + details);
    }

    function processOCR(text) {
      const upper = text.toUpperCase().replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5');

      // Find dates
      const dateMatch = upper.match(/\b(\d{1,2}[\/\-\.\s]\d{1,2}[\/\-\.\s]\d{2,4}|\d{4}[\/\-\.\s]\d{2}[\/\-\.\s]\d{2}|(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)[\s\-\.\/]*\d{1,2}|EXP.{0,30}\d+|BEST BEFORE.{0,30}\d+|USE BY.{0,30}\d+|\d{6,8})\b/gi) || [];
      
      let expiry = null;
      for (let d of dateMatch) {
        const parsed = new Date(d.replace(/EXP|BEST BEFORE|USE BY|BB.?/gi, '').trim());
        if (!isNaN(parsed) && parsed > new Date('2015')) {
          expiry = parsed;
          break;
        }
      }

      let days = expiry ? Math.max(0, Math.ceil((expiry - Date.now()) / 86400000)) : null;

      let title = "Item Detected", details = "", extra = "", icon = "Package";

      if (upper.includes("PASSPORT") || upper.includes("IDENTITY")) { title="Passport/ID"; icon="Passport"; details="Personal document detected"; }
      else if (upper.includes("MEDICINE") || upper.includes("TABLET") || upper.includes("SYRUP") || upper.includes("CAPSULE")) { title="Medicine"; icon="Pill"; details="Pharmaceutical product"; }
      else if (upper.includes("MILK")) { title="Milk"; icon="Milk"; }
      else if (upper.includes("YOGURT") || upper.includes("YOGHURT")) { title="Yogurt"; icon="Yogurt"; }
      else if (upper.includes("EGG")) { title="Eggs"; icon="Egg"; }
      else if (upper.includes("CHICKEN")) { title="Chicken"; icon="Chicken"; }

      if (days !== null) {
        details = days === 0 ? "EXPIRED TODAY!" :
                  days === 1 ? "EXPIRES TOMORROW!" :
                  days <= 3 ? `ONLY ${days} DAYS LEFT!` : `${days} days remaining`;
        extra = `Expiry date: ${expiry.toLocaleDateString()}`;
      } else {
        details = "No expiry date found";
      }

      showResult(title, details, extra, icon);
      speak(title + ". " + details + ". " + extra);
    }

    function showResult(title, details, extra, icon) {
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('title').textContent = title;
      document.getElementById('details').textContent = details;
      document.getElementById('details').style.color = details.includes("EXPIRED") || details.includes("ONLY") ? "#ff0066" : "#00ff88";
      document.getElementById('extra').textContent = extra;
      document.getElementById('icon').textContent = icon;
      confetti({particleCount:500, spread:180, origin:{y:0.6}});
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 0.9;
        utter.pitch = 1;
        speechSynthesis.speak(utter);
      }
    }
  </script>
</body>
</html>